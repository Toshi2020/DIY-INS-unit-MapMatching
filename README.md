# DIY-INS-unit+MapMatching
# 自作自律航法ユニットにマップマッチング機能を追加

**概要**  
前回作成した自律航法ユニット↓に対して、今回マップマッチング機能を追加しました。  
https://github.com/Toshi2020/Low-cost-INS-unit-development-project  

・自作した自律航法ユニット(以下INSユニット)では、GPS正常受信時には常時GPSデータでセンサを校正しながら自律航法の演算を行っています。トンネル等でGPSがロストした以降は、校正済みであろうセンサの値使って引き続き自律航法の演算を行います。  
・しかしながらGPSデータのばらつきは正規分布しているわけではありません。そのためトンネルに入る直前のセンサが正しく校正されているとは限らないので、実力としては2kmを超えるトンネルではナビアプリの誘導経路から外れるケースが増える感じでした。  

**システム構成**  
・INSユニットで得られた位置や速度の情報をシリアルでAndroidヘッドユニットに送り、Android側のアプリで仮の位置情報としてOS側に送っています。  
![システム構成](https://github.com/user-attachments/assets/58dacb53-66db-42f0-b8a5-4b83ccc1c7f3)

・今回の改修は、Android側アプリでINSユニットから取得した位置情報を道路にスナップして、差分をINSユニットへ送り返すことでINSユニット側で位置の補正を行う構成としています。  
・マップマッチングを行うのはトンネル道路部分だけです。  
・トンネル部分の道路データーは、Overpass APIを使って通信によりリアルタイムで取得するか、あらかじめPCで日本の全トンネルデータを抽出したデーターベースファイルを作成してAndroid側に置き、アプリ起動時に読み込むようにしました。  
・Android側アプリの起動時にファイルが存在しない場合は通信で取得するようになっています。  
・データーベースファイルのサイズは16.3MB程度とコンパクトなので起動がもたつくようなことはありません。ただし道路の変更があるでしょうからたまに作り直す必要があるかと思います。  
  
**効果**  
・前回実走時にナビの経路誘導が外れてしまった時の、山手トンネルから大橋ジャンクションへのログデータでHILSシミュレーションした結果です。  
![効果(大橋ジャンクション)](https://github.com/user-attachments/assets/71b9ff0e-00fd-4e78-aa34-f3c29f97ed13)

・長い地下トンネルを南下し、その後トンネル内を西に分岐して地下のジャンクションをグルグルと2周するルートです。右下にジャンクション部分を拡大しています。  
・シミュレーション動画はこちら  
https://youtu.be/dg56o25rdEs  


**回路**  
![自律航法ユニット_4X1 1回路図](https://github.com/user-attachments/assets/637f97a1-b029-4622-b1c4-3d53e81e3f74)

・INSユニット側の前回との違いは、Android側からのシリアル受信を可能とした部分です。Arduinoの持っているUSBシリアルと、外付けのBluetoothシリアルのどちらか一方のみを使う前提です。Arduinoの持っているUSBシリアルチップとATMEGAの間は1kΩの抵抗が入っているので、BluetoothシリアルのTxDとArduinoNANOのRxD端子を負論理のダイオードORで接続しています。Bluetoothシリアルユニットは3.3V仕様なのでレベルコンバーターを通しています。Arduinoからの送信側は抵抗分圧して電圧を下げています。  
  
**ソフトウェア**  
●ExtGPS  
・INSユニットのArduinoのコードです。  
・Arduino IDEでビルドしています。  
  
●GpsSelector  
・Android側のアプリです。  
・Android Studio(ラッコのバージョン)でビルドしています。(前作はキリンのバージョンでビルドしていました。)  
・build/debugフォルダに署名付きでビルドしたapkも入れておきました。  
・Android 13(SDK33)まで対応しています。  
![アプリ説明](https://github.com/user-attachments/assets/f0de88c0-9b52-4e4a-8e8a-2f13db25ec03)

  
●MakeTunnelSQLite  
・WindowsPCで日本全国の道路情報のデータベースファイルを事前に作成するためのJavaスクリプトです。あらかじめPCにNode.jsをインストールしておく必要があります。  
・出来上がったtunnels.sqliteをAndroidのDocumentsフォルダに入れておくと、道路データを通信ではなくこのファイルから取得するようになります。  
  
●Sim_ExtGPS.xls  
・実走時にAndroid側アプリで取得したlogデータを使って机上でシミュレーションするためのEXCELファイルです。INSユニットと同じアルゴリズムがVBAで組み込んであるのでEXCEL単体で検証もできますし、実際のINSユニットのハードウェアにシリアル送信してHILS的なシミュレーションを行うこともできます。  

**シミュレーション手法**  
・ソフトを変更するたびに実走するのは時間の無駄です。実走時に取得したログデータにはGPS以外にもセンサデータが含まれているので、これを使って机上でアルゴリズムの検証ができるようになっています。  
![シミュレーション時システム構成](https://github.com/user-attachments/assets/147d82de-78ee-4795-b8e8-cbfc4c0277ab)

・INSユニットのハードウェアを使ったシミュレーション時は、GPSユニットの接続を外して代わりにPCからのUSBシリアルコンバータのTxとRxとGNDを接続します。INSユニット側はExtGPS.inoで#define _HILSを1にしてビルドして焼いておきます。  
・EXCEL側では[Load]ボタンでログファイルLogxxx.txtを読み込んで、[Run Sim]ボタンでEXCEL上でシミュレーションを、[TxHILS]ボタンでINSユニットに実インターバルでシリアル送信します。この場合INSユニットから位置情報等が送信されるので、Android端末でアプリを起動しておきます。この時Android端末はUSBシリアルよりもBluetoothで接続した方が使い勝手がいいと思います。  
  
**雑感**  
・前作ではAndroid側アプリのオマケの機能としてOSM(Open Street Map)を使って自車位置をマップ上に表示していたのですが、ふとChatGPTに「OSMを使ってマップマッチングってできないかな？」と聞いてみたら、「できますよ」とのこと。それから何度かやり取りして、OverpassやマップマッチングのアルゴリズムやsqliteやAndroid13への対応だのいろいろ教わって2か月足らずで出来てしまいました。自分だけの能力では一生かかっても不可能だったと思います。仕様を勉強する時間を全然取らなくてもできちゃうんですよね。  
・私は趣味なので大歓迎ですが、プロのプログラマーの皆さんはChatGPTってどう思っているのかなぁと気になるところではあります。  
・もともとトンネル内で自車位置を得るために作成したINSユニットですが、そのトンネル内でマップマッチングするなら自律航法の存在意義はあまりないとも言えますね。前作で4年間結構もがき苦しんだ(センサ個別に温特補正するとか各種補正とか)のは何だったの？って感じです。   
それでもメリットとがあるとすれば、  
　①起動直後に衛星を受信するまでの期間も自車位置と方位がわかる。  
　②停止した後でナビの自車の向きがクルクル変わることがない(GPSのばらつきで衛星からの進行方位が変化するため。私のユニットでは車速=0では自車の向きを変化させていないので)  
　③トンネル内の分岐でナビの案内経路を外れたらナビ側でリルートしてくれる。  
　④衛星データは1秒間隔ですが自律航法データは0.1秒間隔なので自車の動きがスムース(ただしGoogleMapナビなどはスムージングが入っているみたいなのであまりメリットはないかも)  
逆にデメリットとしては、  
　①トンネル内の分岐でマップマッチングを間違うとあらぬ方向に自車位置が持って行かれる。(ナビアプリ側の誘導経路情報は取得できないのと自車の進行方向の道路にスナップするアルゴリズムなので)  
・今回はAndroid側で道路へのスナップ処理を行いましたが、INSユニットのCPUをESP32に変更すればSQLiteのライブラリがあるようなので、道路データーベースをSDカードから読み込んでスタンドアロンのマップユニットができるのでよりスマートかも。  

以上です。

